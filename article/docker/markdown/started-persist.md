## DB 유지

컨테이너를 시작할 때마다 작업관리 목록이 비어 있다. 왜 이러한가? 이 부분에서는 컨테이너가 작동하는 방식에
대해 자세히 알아보자.

## 컨테이너의 파일 시스템

컨테이너가 실행되면 이미지의 다양한 레이어를 파일 시스템에 사용한다. 또한 각 컨테이너에는 파일을
생성/업데이트/제거할 수 있는 자체 "스크래치 공간"이 있다. 동일한 이미지를 사용하더라도 다른 컨테이너에서는
변경 내용이 표시되지 않는다.

### 확인해보기
이 작업을 확인하려면 두 개의 컨테이너를 시작하고 각각의 컨테이너에 파일을 만든다. 한 컨테이너에 생성된
파일은 다른 컨테이너에서 사용할 수 없다.

1. 1에서 10000 사이의 난수로 /data.txt라는 파일을 생성할 ubuntu 컨테이너를 시작한다.

```
docker run -d ubuntu bash -c "shuf -i 1-10000 -n 1 -o /data.txt && tail -f /dev/null"
```

명령어가 궁금한 경우 bash 셸을 시작하고 두 개의 명령어(왜 `&&`가 있는지)를 호출해보자. 첫 번째 부분은
단일 난수를 선택하여 `/data.txt`에 쓴다. 두 번째 명령은 컨테이너를 계속 실행하기 위해 파일을 감시하는
것이다.

2. 컨테이너의 터미널에 액세스하여 출력을 볼 수 있는지 확인하자. 이를 위해 CLI 또는 Docker Desktop의
   그래픽 인터페이스를 사용할 수 있다.

### CLI

```
docker exec <container-id> cat /data.txt
```

### Docker Desktop

```
cat /data.txt
```

3. 이제 다른 `ubuntu` 컨테이너(동일한 이미지)를 시작하면 동일한 파일이 없다는 것을 알 수 있다. Mac
   또는 Linux 터미널이나 Windows Command Prompt 또는 PowerShell에서 다음 명령을 사용하여 콘텐츠를
   가져온다.

```
docker run -it ubuntu ls /
```

이 경우 명령어는 컨테이너의 루트 디렉터리에 있는 파일을 나열한다. data.txt 파일이 없다! 그것은 첫 번째
컨테이너에 대해서만 스크래치 공간에 쓰여졌기 때문이다.

4. `docker rm -f <container-id>` 명령을 사용하여 첫 번째 용기를 제거한다.

## 컨테이너 볼륨

이전 실험에서는 각 컨테이너가 시작될 때마다 이미지 정의에서 시작된다는 것을 확인했다. 컨테이너가 파일을
생성, 업데이트 및 삭제할 수 있지만 컨테이너를 제거하면 변경 내용이 손실되고, Docker가 해당 컨테이너의
모든 변경 내용을 격리한다. 볼륨을 사용하면 이 모든 것을 변경할 수 있다.

볼륨은 컨테이너의 특정 파일 시스템 경로를 호스트 시스템에 다시 연결할 수 있는 기능을 제공한다. 컨테이너에
디렉토리를 마운트하면 해당 디렉토리의 변경 내용이 호스트 시스템에도 표시된다. 컨테이너를 다시 시작할 때
동일한 디렉터리를 마운트하면 동일한 파일이 표시된다.

볼륨에는 크게 두 가지 유형이 있다. 결국 둘 다 사용하게 되지만 볼륨 마운트부터 시작해보자.

## 작업관리 데이터 유지

기본적으로 작업관리 앱은 컨테이너의 파일 시스템에 있는 `/etc/todos/todo.db`의 SQLite 데이터베이스에
데이터를 저장한다. SQLite에 대해 잘 모르신다면 걱정하지 않으셔도 된다! 모든 데이터를 하나의 파일에
저장하는 관계형 데이터베이스일 뿐이다. 대규모 애플리케이션에는 적합하지 않지만 소규모 데모에는 적합하다.
나중에 다른 데이터베이스 엔진으로 전환하는 방법을 배우게 된다.

데이터베이스가 단일 파일인 경우 호스트에서 해당 파일을 유지하고 다음 컨테이너에 사용할 수 있도록 설정할 수
있으면 마지막 컨테이너가 중단된 위치에서 해당 파일을 선택할 수 있다. 볼륨을 생성하고 데이터를 저장한
디렉터리에 연결("마운트"라고 함)하면 데이터를 유지할 수 있다. 컨테이너가 `todo.db` 파일에 쓸 때
볼륨의 호스트에 데이터를 유지한다.

언급했듯이 볼륨 마운트를 사용한다. 볼륨 마운트를 불투명한 데이터 버킷으로 생각한다. Docker는 디스크의
저장 위치를 포함하여 볼륨을 완전히 관리한다. 볼륨 이름만 기억하면 된다.

1. `docker volume create` 명령을 사용하여 볼륨을 생성합니다.

```
docker volume create todo-db
```

2. 영구 볼륨을 사용하지 않고 계속 실행 중이므로 작업관리 앱 컨테이너를 중지하고 대시보드(또는
   `docker rm -f` 사용)에서 다시 한 번 제거한다.
3. 작업관리 앱 컨테이너를 시작하지만 `--mount` 옵션을 추가하여 볼륨 마운트를 지정한다. 볼륨에 이름을
   지정하고 컨테이너의 `/etc/todos`에 마운트한다. 그러면 경로에서 생성된 모든 파일이 캡처된다.

```
docker run -dp 3000:3000 --mount type=volume,src=todo-db,target=/etc/todos getting-started
```

4. 컨테이너가 시작되면 앱을 열고 작업관리 목록에 몇 가지 항목을 추가한다.

![](https://docs.docker.com/get-started/images/items-added.png)

5. 작업관리 앱의 컨테이너를 중지하고 제거한다. 대시보드 또는 `docker ps`를 사용하여 ID를 가져온 다음
   `docker rm -f` 를 사용하여 ID를 제거한다.
6. 위에서 동일한 명령을 사용하여 새 컨테이너를 시작한다.
7. 앱을 연다. 목록에 항목이 남아 있어야 한다.
8. 목록 체크아웃을 마치면 컨테이너를 제거하자.

이제 데이터를 유지하는 방법을 배웠다.

## 볼륨으로 이동

많은 사람들이 "볼륨을 사용할 때 Docker가 데이터를 어디에 저장합니까?"라고 자주 묻는다. 알고 싶은 경우
`docker volume inspect` 명령을 사용하면 된다.

```
docker volume inspect todo-db
[
    {
        "CreatedAt": "2019-09-26T02:18:36Z",
        "Driver": "local",
        "Labels": {},
        "Mountpoint": "/var/lib/docker/volumes/todo-db/_data",
        "Name": "todo-db",
        "Options": {},
        "Scope": "local"
    }
]
```

`Mountpoint`은 디스크에서 데이터의 실제 위치이다. 대부분의 컴퓨터에서는 호스트에서 이 디렉토리에
액세스하려면 루트 액세스 권한이 있어야 한다.

> ### Docker Desktop에서 볼륨 데이터에 직접 액세스
>
> Docker Desktop에서 실행되는 동안 Docker 명령은 실제로 시스템의 작은 VM 내에서 실행된다. 마운트
> 지점 디렉토리의 실제 내용을 보려면 해당 VM 내부를 살펴봐야 한다.
